<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="css/adminlte.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css"
          integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/"
          crossorigin="anonymous">
    <link rel="stylesheet" href="css/normalize.css">
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700" rel="stylesheet">
    <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link rel="stylesheet" href="css/style.css">

    <title>POS</title>
</head>

<body class="hold-transition sidebar-mini">
<div class="wrapper">

    <nav class="main-header navbar navbar-expand bg-white navbar-light border-bottom"
         style="background-color: #3c8dbc !important;">
        <!-- Left navbar links -->
        <ul class="navbar-nav">
            <li class="nav-item">
                <a class="nav-link" data-widget="pushmenu" href="#"><i class="fa fa-bars"></i></a>
            </li>


        </ul>


        <!-- Right navbar links -->
        <ul class="navbar-nav ml-auto">
            <li></li>
        </ul>
    </nav>

    <aside class="main-sidebar sidebar-dark-primary elevation-4" style="min-height: 675px; box-shadow: none;">
        <!-- Brand Logo -->
        <a href="index3.html" class="brand-link"
           style="padding-left: 0px !important;padding-right: 0px !important; background-color: #367fa9;">
            <img src="image/pos%20logo.png" alt="AdminLTE Logo" class="brand-image img-circle elevation-3"
                 style="opacity: .8;">
            <span class="brand-text font-weight-light">Point Of Sale</span>
        </a>

        <!-- Sidebar -->
        <div class="sidebar" style="padding-left: 0px !important;padding-right: 0px !important;">
            <!-- Sidebar user panel (optional) -->
            <div class="user-panel mt-3 pb-3 mb-3 d-flex navigation">

                <div class="info " style=" position: relative;left: 50px;">
                    <a href="#" class="d-block">Main Navigation</a>
                </div>
            </div>

            <!-- Sidebar Menu -->
            <nav class="mt-2">
                <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu"
                    data-accordion="false">

                    <li class="nav-item">
                        <a href="index.html" class="nav-link ">
                            <i class="fas fa-tachometer-alt"></i>
                            <p style="position: relative;left: 10px;">
                                Dashboard

                            </p>
                        </a>
                    </li>

                    <li class="nav-item">
                        <a href="customer.html" class="nav-link ">
                            <i class="fas fa-user"></i>
                            <p style="position: relative;left: 10px;">
                                Manage Customers

                            </p>
                        </a>
                    </li>

                    <li class="nav-item">
                        <a href="item.html" class="nav-link ">
                            <i class="fas fa-list-ul"></i>
                            <p style="position: relative;left: 10px;">
                                Manage Items

                            </p>
                        </a>
                    </li>

                    <li class="nav-item">
                        <a href="placeOrder.html" class="nav-link active">
                            <i class="fas fa-shopping-cart"></i>
                            <p style="position: relative;left: 10px;">
                                Place Order

                            </p>
                        </a>
                    </li>
                </ul>
            </nav>
            <!-- /.sidebar-menu -->
        </div>
        <!-- /.sidebar -->
    </aside>
</div>

<div class="content-wrapper ">
    <!-- Content Header (Page header) -->
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-8">
                    <h1 class="m-0 text-dark">Place Order
                        <small style="font-size: 15px;color: #777;"> Select Items,Quantities and Place Orders</small>
                    </h1>

                </div><!-- /.col -->
                <div class="col-sm-4">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="index.html">Home</a></li>
                        <li class="breadcrumb-item active">Place Order</li>
                    </ol>
                </div>

            </div><!-- /.row -->
        </div><!-- /.container-fluid -->
        <hr>
    </div>


    <div class="row orders">
        <div id="col1" class="col-md-4">
            <div id="order-details" class="alert alert-warning">
                <div>Order ID: <label id="lblOrderId"></label></div>
                <div>Order Date: <label id="lblOrderDate"></label></div>
            </div>
            <div class="alert alert-primary">
                <div class="form-group">
                    Customer ID:
                    <select id="cmbCustomerID" class="form-control">
                        <option selected="" disabled="" hidden="">-Select Customer ID-</option>

                    </select>
                </div>
                <div>Customer Name: <label id="lblCustomerName"></label></div>
            </div>
            <div id="item-container" class="alert alert-dark">
                <div class="form-group">
                    Item Code:
                    <select id="cmbItemID" class="form-control">
                        <option selected="" disabled="" hidden=""> -Select Item ID-</option>

                    </select>
                </div>
                <div id="item-details">
                    <div>Item Name: <label id="lblItemName"></label></div>
                    <div>Unit Price: <label id="lblUnitPrice"></label></div>
                    <div>Qty. On Hand: <label id="lblQtyOnHand"></label></div>
                </div>
                <div class="form-group">
                    Qty.
                    <input class="form-control" type="number" id="txtQty" min="0">
                </div>
                <div>
                    <button id="btnAddCart" class="btn btn-warning" style="font-weight: bold;"><i
                            class="fas fa-cart-plus"></i> Add to Cart
                    </button>
                    <button type="reset" class="btn btn-danger" style="width:75px;font-weight: bold;font-weight: bold;">
                        clear
                    </button>
                </div>
            </div>

        </div>
        <div id="col2" class="col-md-8">
            <div class="alert alert-success" style="height: 535px;">
                <div id="tblContainer" class="table-dark" style="height: 465px;">
                    <table id="tblOrderDetails" class="table table-hover table-dark">
                        <thead>
                        <tr>
                            <th class="text-center">Item Code</th>
                            <th class="text-center">Name</th>
                            <th class="text-center">Unit Price</th>
                            <th class="text-center">Qty</th>
                            <th class="text-center">Total</th>
                            <th></th>
                        </tr>
                        </thead>
                        <tbody style="cursor:pointer;">

                        </tbody>
                    </table>
                </div>
                <div>
                    <span id="spnTotal" class="orderDetails-footer" style="font-size: 25px;">Total: <label
                            id="lblTotal">0.0</label></span>
                    <button id="btnPlaceOrder" class="btn btn-primary orderDetails-footer"
                            style="float: right;font-weight: bold;"><i
                            class="fas fa-cart-arrow-down"></i>
                        Place Order
                    </button>
                </div>

            </div>
        </div>
    </div>

    <div class="row orders">
        <div class="col-12">
            <h3 class="text-center">Order Details</h3>
        </div>
        <table id="tblOrders" class="table table-bordered table-hover">
            <thead>
            <tr>
                <th class="text-center">Order ID</th>
                <th class="text-center">Order Date</th>
                <th class="text-center">Customer ID</th>
                <th class="text-center">Customer Name</th>
                <th class="text-center">OrderDto Total</th>
            </tr>
            </thead>
            <tbody>


            </tbody>
        </table>
    </div>


</div>

<script src="js/date-formatter.js"></script>
<script src="js/jquery.min.js"></script>
<script src="js/bootstrap.bundle.min.js"></script>
<script src="js/adminlte.min.js"></script>


<script>
    var qty_onHand = 0;
    var tempDB = 0;

    $(document).ready(function () {

        var today = new Date();
        var formattedDate = today.format("yyyy-mm-dd");
        $("#lblOrderDate").text(formattedDate);

        var ordersCount = $("#tblOrders tbody tr").length + 1;
        $("#lblOrderId").text(ordersCount);


        var ajaxConfig = {
            method: "GET",
            url: "http://localhost:3000/api/v1/customers",
            async: true

        };

        $.ajax(ajaxConfig).done(function (response, statusText, jxhr) {

            for (i = 0; i < response.length; i++) {
                $("#cmbCustomerID").append("<option>" + response[i].id + "</option>");
            }

        }).fail(function (jxhr, statusText, error) {
            console.log(error);
        });


        var ajaxConfig = {
            method: "GET",
            url: "http://localhost:3000/api/v1/items",
            async: true

        };

        $.ajax(ajaxConfig).done(function (response, statusText, jxhr) {
            tempDB = response;

            for (var i = 0; i < tempDB.length; i++) {

                $("#cmbItemID").append("<option>" + tempDB[i].code + "</option>");
            }


        }).fail(function (jxhr, statusText, error) {
            console.log(error);
        });


    });


    $("#cmbCustomerID").change(function () {


        var ajaxConfig = {
            method: "GET",
            url: "http://localhost:3000/api/v1/customers/" + $(this).val(),
            async: true

        };

        $.ajax(ajaxConfig).done(function (response, statusText, jxhr) {

            $("#lblCustomerName").text(response.name);

        }).fail(function (jxhr, statusText, error) {
            console.log(error);
        })


    });


    $("#cmbItemID").change(function () {

        for (var i = 0; i < tempDB.length; i++) {
            if (tempDB[i].code == $(this).val()) {
                $("#lblItemName").text(tempDB[i].name);
                $("#lblUnitPrice").text(tempDB[i].unitPrice + ".00");
                $("#lblQtyOnHand").text(tempDB[i].qtyOnHand);

                qty_onHand = parseInt(tempDB[i].qtyOnHand);
            }
        }

    });


    $("#btnAddCart").click(function () {

            if ($("#lblCustomerName").text() == "") {
                alert("Please select a Customer");
                return;
            }

            if ($("#lblItemName").text() == "" || $("#lblUnitPrice").text() == "" || $("#lblQtyOnHand").text() == "") {
                alert("Please select a Item");
                return;
            }

            if ($("#txtQty").val() == "") {
                alert("Please Enter a quantity");
                return;
            }

            var typedQty = $("#txtQty").val();
            if (typedQty > qty_onHand) {
                alert("Please Enter a valid quantity");
                $("#txtQty").focus();
                $("#txtQty").select();
                return;
            }

            if (typedQty < 0) {
                alert("Please Enter a valid quantity");
                $("#txtQty").focus();
                $("#txtQty").select();
                return;
            }


            if ($("#cmbItemID").attr("disabled")) {

                var rows=$("#tblOrderDetails tbody tr");

                for(var i=0;i<rows.length;i++){
                    if($(rows[i]).find("td:first-child").text()== $("#cmbItemID").val()){
                        $(rows[i]).find("td:nth-child(4)").text($("#txtQty").val());
                        $(rows[i]).find("td:nth-child(5)").text($("#txtQty").val()*parseInt($("#lblUnitPrice").text()));


                        var ajaxConfig = {
                            method: "GET",
                            url: "http://localhost:3000/api/v1/items/"+$(rows[i]).find("td:first-child").text(),
                            async: false

                        };

                        $.ajax(ajaxConfig).done(function (response, statusText, jxhr) {

                            tempDB[i].qtyOnHand=response.qtyOnHand- $("#txtQty").val();


                        }).fail(function (jxhr, statusText, error) {
                            console.log(error);
                        });



                    }
                }


                $("#cmbItemID").attr("disabled", false);
                $("#btnAddCart").html("<i class='fas fa-cart-plus'></i> Add to Cart");
                clear();
                calculateTotal();

            }

            else {
                var total = parseInt($("#lblUnitPrice").text()) * $("#txtQty").val();
                $("#tblOrderDetails tbody").append("<tr><td class='text-center'>" + $("#cmbItemID").val() + "</td><td class='text-center'>" + $("#lblItemName").text() + "</td><td class='text-center'>" + $("#lblUnitPrice").text() + "</td><td class='text-center' >" + $("#txtQty").val() + "</td><td class='text-center' >" + total + "</td><td><img src='image/recyclebin.png' width='48px' alt='delete' class='deleteImg'></td>");
                $("#tblContainer").css("overflow-y", 'scroll');
                calculateTotal();

                for (var i = 0; i < tempDB.length; i++) {
                    var selectedItemCode = $("#cmbItemID").val();

                    if (selectedItemCode == tempDB[i].code) {
                        tempDB[i].qtyOnHand = tempDB[i].qtyOnHand - $("#txtQty").val();

                    }
                }

                clear();

                $(".deleteImg").mouseover(function () {
                    $(this).attr("src", 'image/recyclebin-hover.png');
                });

                $(".deleteImg").mouseout(function () {
                    $(this).attr("src", 'image/recyclebin.png');
                });


                $(".deleteImg").off("click");
                $(".deleteImg").click(function (eventData) {

                    var deletedItemQty = parseInt($(this).parents("tr").find("td:nth-child(4)").text());
                    var deletedItemCode = $(this).parents("tr").find("td:first-child").text();


                    for (i = 0; i < tempDB.length; i++) {
                        if (deletedItemCode == tempDB[i].code) {
                            tempDB[i].qtyOnHand = tempDB[i].qtyOnHand + deletedItemQty;
                        }
                    }


                    // $(this).parent().parent().fadeOut(500);
                    //
                    // setTimeout(function () {

                    $(this).parents("tr").remove();


                    // }, 600);

                    $("#cmbItemID").attr("disabled", false);
                    $("#btnAddCart").html("<i class='fas fa-cart-plus'></i> Add to Cart");
                    eventData.stopPropagation();
                    console.log(calculateTotal());
                    clear();

                });


                $("#tblOrderDetails tbody tr").click(function () {
                    $("#cmbItemID").attr("disabled", true);
                    $("#btnAddCart").html("<i class='fas fa-cart-plus'></i> Update Cart");

                    $("#cmbItemID").val($(this).find("td:first-child").text());
                    $("#lblItemName").text($(this).find("td:nth-child(2)").text());
                    $("#lblUnitPrice").text($(this).find("td:nth-child(3)").text());

                    $("#txtQty").val($(this).find("td:nth-child(4)").text());

                    for (var i = 0; i < tempDB.length; i++) {
                        if (tempDB[i].code == $(this).find("td:first-child").text()) {
                            $("#lblQtyOnHand").text(tempDB[i].qtyOnHand);
                        }
                    }


                });


            }
        });


    $("button[type='reset']").click(function () {

        $("#btnAddCart").html("<i class='fas fa-cart-plus'></i> Add to Cart");
        $("#cmbItemID").attr("disabled", false);
        clear();

    });


    function calculateTotal() {
        var rows = $("#tblOrderDetails tbody tr");
        var total = 0;
        for (var i = 0; i < rows.length; i++) {
            total += parseFloat($(rows[i]).find("td:nth-child(5)").text());
        }

        $("#lblTotal").text(total + ".00");
        return total;
    }

    function clear() {
        $("#cmbItemID").val("-Select Item ID-");
        $("#lblItemName").text("");
        $("#lblUnitPrice").text("");
        $("#lblQtyOnHand").text("");
        $("#txtQty").val("");
    }


</script>

</body>

</html>